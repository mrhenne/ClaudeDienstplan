<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dienstplan PRO ‚Äì Helios Duisburg</title>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ============================================================
  // üî• FIREBASE KONFIGURATION ‚Äì HIER EIGENE DATEN EINTRAGEN!
  // Erstelle ein Projekt auf https://console.firebase.google.com
  // ============================================================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  let db = null;
  let firebaseReady = false;

  try {
    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      firebaseReady = true;
      console.log("Firebase connected");
    }
  } catch(e) {
    console.warn("Firebase not configured, using localStorage only", e);
  }

  window.__firebaseDB = db;
  window.__firebaseReady = firebaseReady;
  window.__firestoreAPI = { doc, setDoc, getDoc, onSnapshot };

  // Signal app that Firebase is ready
  window.dispatchEvent(new Event('firebaseReady'));
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ==========================================
   CSS VARIABLES & RESET
   ========================================== */
:root {
  /* === LIQUID GLASS ‚Äì LIGHT === */
  --bg: #e8edf8;
  --bg-mesh: radial-gradient(ellipse at 20% 20%, #c7d7f8 0%, transparent 50%),
             radial-gradient(ellipse at 80% 10%, #d4c8f8 0%, transparent 45%),
             radial-gradient(ellipse at 60% 80%, #c8dff8 0%, transparent 50%),
             radial-gradient(ellipse at 10% 75%, #e8d0fa 0%, transparent 45%),
             linear-gradient(135deg, #dce7f9 0%, #ece4fa 100%);
  --glass:    rgba(255,255,255,0.60);
  --glass2:   rgba(255,255,255,0.40);
  --glass3:   rgba(255,255,255,0.25);
  --glass-border: rgba(255,255,255,0.75);
  --glass-border2: rgba(255,255,255,0.40);
  --surface: rgba(255,255,255,0.68);
  --surface2: rgba(255,255,255,0.45);
  --border: rgba(180,190,220,0.45);
  --text: #181c2e;
  --text2: #4a5278;
  --text3: #8892b8;
  --accent: #3b5bff;
  --accent2: #7c3aed;
  --accent-light: rgba(59,91,255,0.12);
  --header-bg: rgba(18,20,38,0.80);
  --header-glass: rgba(255,255,255,0.06);
  --header-border: rgba(255,255,255,0.10);
  --sidebar-bg: rgba(18,20,38,0.85);
  --weekend: rgba(254,243,217,0.55);
  --holiday: rgba(254,226,226,0.55);
  --today: rgba(219,234,254,0.65);
  --shadow: 0 2px 8px rgba(60,80,140,0.07), 0 8px 24px rgba(60,80,140,0.06);
  --shadow-lg: 0 12px 40px rgba(40,50,120,0.14), 0 2px 8px rgba(40,50,120,0.07);
  --shadow-glass: 0 8px 32px rgba(60,80,180,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
  --radius: 12px;
  --radius-sm: 7px;
  --radius-lg: 18px;
  --transition: 0.18s cubic-bezier(.4,0,.2,1);
  --blur: blur(18px) saturate(1.6);
  --blur-sm: blur(10px) saturate(1.4);
  --table-zoom: 1; /* initialized here; updated via JS on zoom change */
}

[data-theme="dark"] {
  /* === LIQUID GLASS ‚Äì DARK === */
  --bg: #0c0e1a;
  --bg-mesh: radial-gradient(ellipse at 20% 20%, rgba(59,91,255,0.18) 0%, transparent 50%),
             radial-gradient(ellipse at 80% 10%, rgba(124,58,237,0.15) 0%, transparent 45%),
             radial-gradient(ellipse at 60% 80%, rgba(16,185,129,0.08) 0%, transparent 50%),
             radial-gradient(ellipse at 10% 75%, rgba(217,70,239,0.10) 0%, transparent 45%),
             linear-gradient(135deg, #0d1025 0%, #12101e 100%);
  --glass:    rgba(255,255,255,0.07);
  --glass2:   rgba(255,255,255,0.05);
  --glass3:   rgba(255,255,255,0.03);
  --glass-border: rgba(255,255,255,0.12);
  --glass-border2: rgba(255,255,255,0.07);
  --surface: rgba(255,255,255,0.07);
  --surface2: rgba(255,255,255,0.04);
  --border: rgba(255,255,255,0.10);
  --text: #eef0ff;
  --text2: #9099c0;
  --text3: #5a6080;
  --accent: #5b7fff;
  --accent2: #9d6fff;
  --accent-light: rgba(91,127,255,0.18);
  --header-bg: rgba(8,9,18,0.85);
  --header-glass: rgba(255,255,255,0.04);
  --header-border: rgba(255,255,255,0.07);
  --sidebar-bg: rgba(8,9,18,0.88);
  --weekend: rgba(40,30,5,0.6);
  --holiday: rgba(40,10,10,0.6);
  --today: rgba(20,40,100,0.5);
  --shadow: 0 2px 8px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.3);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3);
  --shadow-glass: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  background-image: var(--bg-mesh);
  background-attachment: fixed;
  color: var(--text);
  height: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: background 0.4s, color 0.3s;
}
/* Noise texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
  opacity: 0.4;
}

/* ==========================================
   SCROLLBAR
   ========================================== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(130,140,180,0.3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(130,140,180,0.5); }

/* ==========================================
   HEADER ‚Äì LIQUID GLASS
   ========================================== */
#header {
  background: var(--header-bg);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  color: #ffffff;
  padding: 0 20px;
  height: 58px;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-shrink: 0;
  z-index: 100;
  border-bottom: 1px solid var(--header-border);
  box-shadow: 0 4px 24px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.06);
  position: relative;
}
.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.logo-icon {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px;
  box-shadow: 0 2px 12px rgba(91,127,255,0.4);
}
.logo-text { line-height: 1.2; }
.logo-title { font-weight: 700; font-size: 14px; letter-spacing: 0.3px; color: white; }
.logo-sub { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1.2px; }

.header-divider { width: 1px; height: 28px; background: var(--header-border); flex-shrink: 0; }

.view-toggle {
  display: flex;
  background: rgba(255,255,255,0.07);
  border: 1px solid var(--header-border);
  border-radius: 8px;
  padding: 2px;
  gap: 2px;
  flex-shrink: 0;
  backdrop-filter: var(--blur-sm);
}
.view-btn {
  padding: 5px 13px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.55);
  cursor: pointer;
  border-radius: 6px;
  font-family: inherit;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.6px;
  transition: all var(--transition);
}
.view-btn.active {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 2px 10px rgba(91,127,255,0.4);
}
.view-btn:not(.active):hover { background: rgba(255,255,255,0.12); color: white; }

.month-nav {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.month-nav button {
  width: 28px; height: 28px;
  border: 1px solid var(--header-border);
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.8);
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  backdrop-filter: var(--blur-sm);
}
.month-nav button:hover { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.25); }
.month-label {
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 1.5px;
  min-width: 130px;
  text-align: center;
  font-family: 'Space Mono', monospace;
  color: rgba(255,255,255,0.92);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background var(--transition);
}
.month-label:hover { background: rgba(255,255,255,0.08); }

.zoom-control {
  display: flex;
  align-items: center;
  gap: 7px;
  flex-shrink: 0;
}
.zoom-control button {
  width: 24px; height: 24px;
  border: 1px solid var(--header-border);
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.75);
  border-radius: 50%;
  cursor: pointer;
  font-size: 15px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.zoom-control button:hover { background: rgba(255,255,255,0.18); }
.zoom-slider {
  -webkit-appearance: none;
  width: 70px; height: 3px;
  border-radius: 2px;
  background: rgba(255,255,255,0.18);
  outline: none;
  cursor: pointer;
}
.zoom-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 13px; height: 13px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(91,127,255,0.5);
}
.zoom-label {
  font-size: 10px;
  color: rgba(255,255,255,0.45);
  font-family: 'Space Mono', monospace;
  min-width: 32px;
}

.workdays-badge {
  background: rgba(91,127,255,0.18);
  color: rgba(180,200,255,0.95);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid rgba(91,127,255,0.3);
  flex-shrink: 0;
  backdrop-filter: var(--blur-sm);
}

.header-spacer { flex: 1; }

.sync-badge {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 500;
  flex-shrink: 0;
  backdrop-filter: var(--blur-sm);
}
.sync-badge.online  { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
.sync-badge.offline { background: rgba(239,68,68,0.12);  color: #fca5a5; border: 1px solid rgba(239,68,68,0.25); }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; }
.sync-badge.online  .sync-dot { background: #10b981; animation: pulse 2s infinite; }
.sync-badge.offline .sync-dot { background: #ef4444; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

.header-btn {
  width: 34px; height: 34px;
  border: 1px solid var(--header-border);
  background: rgba(255,255,255,0.07);
  color: rgba(255,255,255,0.75);
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
  flex-shrink: 0;
  backdrop-filter: var(--blur-sm);
}
.header-btn:hover { background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.2); color: white; transform: translateY(-1px); }
.header-btn.active { background: linear-gradient(135deg, rgba(91,127,255,0.5), rgba(124,58,237,0.5)); border-color: rgba(91,127,255,0.5); color: white; }
.header-btn.locked { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #fca5a5; }

.export-btn, .save-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 15px;
  border-radius: 10px;
  cursor: pointer;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  transition: all var(--transition);
  flex-shrink: 0;
  border: 1px solid transparent;
}
.export-btn {
  background: rgba(255,255,255,0.09);
  color: rgba(255,255,255,0.8);
  border-color: var(--header-border);
  backdrop-filter: var(--blur-sm);
}
.export-btn:hover { background: rgba(255,255,255,0.16); color: white; transform: translateY(-1px); }
.save-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 3px 14px rgba(91,127,255,0.45);
}
.save-btn:hover { box-shadow: 0 6px 20px rgba(91,127,255,0.55); transform: translateY(-1px); }

/* ==========================================
   MAIN LAYOUT
   ========================================== */
#main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ==========================================
   SIDEBAR ‚Äì LIQUID GLASS
   ========================================== */
#sidebar {
  width: 72px;
  background: var(--sidebar-bg);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 5px;
  overflow-y: auto;
  flex-shrink: 0;
  border-right: 1px solid var(--header-border);
  position: relative;
  z-index: 1;
}

.sidebar-shift-btn {
  width: 46px; height: 42px;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 11px;
  cursor: grab;
  font-weight: 700;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: all var(--transition);
  position: relative;
  letter-spacing: 0.3px;
  gap: 2px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2);
}
.sidebar-shift-btn:active { cursor: grabbing; }
.sidebar-shift-btn:hover { transform: scale(1.1) translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.25); }
.sidebar-shift-btn.selected {
  box-shadow: 0 0 0 2.5px white, 0 6px 16px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.3);
  transform: scale(1.05);
}
.sidebar-shift-btn.dragging-shift  { opacity: 0.35; transform: scale(0.9); cursor: grabbing; }
.sidebar-shift-btn.drag-over-shift { box-shadow: 0 0 0 2.5px var(--accent), 0 4px 14px rgba(0,0,0,0.3); transform: scale(1.06); }
.sidebar-shift-btn span { font-size: 7px; font-weight: 500; font-family: 'DM Sans', sans-serif; opacity: 0.75; }

.sidebar-divider { width: 34px; height: 1px; background: rgba(255,255,255,0.1); margin: 3px 0; }

/* ==========================================
   TABLE CONTAINER ‚Äì GLASS
   ========================================== */
#table-container {
  flex: 1;
  overflow: auto;
  padding: 14px;
  background: transparent;
  position: relative;
  z-index: 1;
}

#plan-wrapper {
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: var(--shadow-glass);
  border: 1px solid var(--glass-border);
  min-width: fit-content;
}

/* ==========================================
   TABLE
   ========================================== */
#plan-table {
  border-collapse: collapse;
  font-size: 12px;
  width: 100%;
  transform-origin: top left;
  transition: transform 0.1s;
}

/* Header row */
#plan-table thead th {
  background: rgba(14,16,32,0.82);
  backdrop-filter: var(--blur);
  color: rgba(255,255,255,0.88);
  padding: 0;
  white-space: nowrap;
  font-weight: 600;
  letter-spacing: 0.3px;
  border: none;
  position: sticky;
  top: 0;
  z-index: 10;
}

.th-inner {
  padding: 6px 4px;
  border-right: 1px solid rgba(255,255,255,0.07);
  min-height: 60px;
  height: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1px;
}

.th-employee { min-width: 150px; align-items: flex-start !important; padding-left: 14px !important; }
.col-stat { min-width: 38px; font-size: 11px; font-family: 'Space Mono', monospace; }

.th-day-num {
  font-size: 15px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  line-height: 1;
}
.th-day-name {
  font-size: 9px;
  font-weight: 500;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  opacity: 0.5;
}

.th-weekend { background: rgba(30,20,10,0.88) !important; }
.th-holiday { background: rgba(40,10,10,0.88) !important; }
.th-today   { background: rgba(20,40,100,0.88) !important; }

/* Warning pulse on understaffed days ‚Äì scales with zoom */
:root { --table-zoom: 1; }
.warn-dot {
  width: calc(8px / var(--table-zoom));
  height: calc(8px / var(--table-zoom));
  min-width: 5px; min-height: 5px;
  max-width: 14px; max-height: 14px;
  border-radius: 50%;
  background: #f59e0b;
  margin-top: 1px;
  flex-shrink: 0;
  animation: warnPulse 1.4s ease-in-out infinite;
}
.warn-dot.critical {
  background: #ef4444;
  animation: warnPulseCritical 1.0s ease-in-out infinite;
}
@keyframes warnPulse {
  0%   { box-shadow: 0 0 0 0 rgba(245,158,11,0.8); transform: scale(1); }
  50%  { box-shadow: 0 0 0 calc(5px / var(--table-zoom)) rgba(245,158,11,0); transform: scale(1.2); }
  100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); transform: scale(1); }
}
@keyframes warnPulseCritical {
  0%   { box-shadow: 0 0 0 0 rgba(239,68,68,0.9); transform: scale(1); }
  50%  { box-shadow: 0 0 0 calc(6px / var(--table-zoom)) rgba(239,68,68,0); transform: scale(1.25); }
  100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); transform: scale(1); }
}
/* Warn row: dot + labels inline */
.warn-row {
  display: flex;
  align-items: center;
  gap: calc(3px / var(--table-zoom));
  justify-content: center;
  margin-top: 2px;
  flex-wrap: wrap;
  max-width: 100%;
  overflow: hidden;
}
.warn-label {
  font-size: calc(8px / var(--table-zoom));
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  letter-spacing: 0;
  line-height: 1;
  background: rgba(245,158,11,0.2);
  color: #f59e0b;
  border-radius: calc(3px / var(--table-zoom));
  padding: calc(1.5px / var(--table-zoom)) calc(3.5px / var(--table-zoom));
  white-space: nowrap;
  min-font-size: 6px;
}
.warn-label.critical {
  background: rgba(239,68,68,0.22);
  color: #ef4444;
}

/* Cells */
#plan-table td {
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  padding: 0;
  vertical-align: top;
}

.employee-cell {
  min-width: 150px;
  padding: 7px 10px 7px 14px;
  cursor: pointer;
  background: var(--glass);
  backdrop-filter: var(--blur-sm);
  position: sticky;
  left: 0;
  z-index: 5;
  border-right: 1px solid var(--glass-border2) !important;
}
.employee-cell:hover { background: var(--glass2); }
.emp-name { font-weight: 700; font-size: 11.5px; color: var(--text); letter-spacing: 0.1px; }
.emp-role  { font-size: 9.5px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.6px; margin-top: 1px; }

.stat-cell {
  text-align: center;
  vertical-align: middle;
  padding: 6px 4px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  position: sticky;
  z-index: 4;
}
.stat-cell.negative { color: #f87171; }
.stat-cell.positive { color: #34d399; }
.stat-vz { color: var(--accent); }

.day-cell {
  min-width: 54px;
  width: 54px;
  min-height: 56px;
  text-align: center;
  vertical-align: top;
  cursor: pointer;
  transition: background var(--transition);
  position: relative;
  padding-bottom: 4px;
}
/* Cells with notes get a bit more height so note chip fits */
.day-cell.has-note {
  min-height: 72px;
}
.day-cell:hover { background: var(--surface2); }
.day-cell.weekend { background: var(--weekend); }
.day-cell.holiday { background: var(--holiday); }
.day-cell.today-col { background: var(--today); }

/* Note-edit overlay on hover */
.day-cell:hover .note-edit-btn { opacity: 1; }
.note-edit-btn {
  position: absolute;
  top: 2px; right: 2px;
  width: 14px; height: 14px;
  border-radius: 3px;
  background: rgba(37, 99, 235, 0.15);
  border: none;
  cursor: pointer;
  font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  opacity: 0;
  transition: opacity 0.15s, background 0.15s;
  color: var(--accent);
  z-index: 2;
  padding: 0;
}
.note-edit-btn:hover { background: rgba(37, 99, 235, 0.3); }

.shift-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 28px;
  border-radius: 6px;
  font-weight: 700;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  margin-top: 5px;
  letter-spacing: 0.3px;
  line-height: 1;
  transition: transform 0.1s;
  cursor: pointer;
  position: relative;
}
.shift-badge:hover { transform: scale(1.08); }
.shift-badge .note-dot {
  position: absolute;
  top: -3px; right: -3px;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #f59e0b;
  border: 1.5px solid var(--surface);
  box-shadow: 0 0 4px rgba(245,158,11,0.6);
}
/* Tausch-Marker */
.shift-badge .swap-dot {
  position: absolute;
  top: -3px; left: -3px;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #06b6d4, #0ea5e9);
  border: 1.5px solid var(--surface);
  box-shadow: 0 0 6px rgba(6,182,212,0.7);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px;
  animation: swapPulse 2s ease-in-out infinite;
}
@keyframes swapPulse {
  0%,100% { box-shadow: 0 0 4px rgba(6,182,212,0.7); }
  50%      { box-shadow: 0 0 10px rgba(6,182,212,1); }
}

/* Stats Modal */
.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.stats-table th {
  text-align: left;
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text3);
  border-bottom: 1.5px solid var(--border);
}
.stats-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  vertical-align: middle;
}
.stats-table tr:last-child td { border-bottom: none; }
.stats-table tr:hover td { background: var(--glass2); }
.stats-bar-wrap {
  width: 90px;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.stats-bar {
  height: 100%;
  border-radius: 3px;
  transition: width 0.4s ease;
}
.stats-summary {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}
.stats-card {
  background: var(--glass2);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 14px;
  text-align: center;
  backdrop-filter: var(--blur-sm);
}
.stats-card-val {
  font-size: 22px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  color: var(--accent);
  line-height: 1;
}
.stats-card-lbl {
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-top: 4px;
}

/* Inline note chip below badge */
.shift-note-tag {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 2px auto 0;
  padding: 2px 5px;
  border-radius: 4px;
  background: rgba(245, 158, 11, 0.13);
  border: 1px solid rgba(245, 158, 11, 0.35);
  max-width: 50px;
  width: 50px;
  overflow: hidden;
  cursor: help;
}
.shift-note-tag-text {
  font-size: 7px;
  color: #92400e;
  font-style: italic;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 44px;
  line-height: 1.3;
}
[data-theme="dark"] .shift-note-tag { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); }
[data-theme="dark"] .shift-note-tag-text { color: #fcd34d; }

/* Note-only chip (no shift assigned) */
/* Ruhezeit-Verletzung Badge (ND‚ÜíFD <11h) */
.rest-violation-badge {
  position: absolute;
  bottom: calc(2px / var(--table-zoom));
  left: 50%;
  transform: translateX(-50%);
  font-size: calc(7px / var(--table-zoom));
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  background: rgba(239,68,68,0.18);
  color: #f87171;
  border: 1px solid rgba(239,68,68,0.4);
  border-radius: calc(3px / var(--table-zoom));
  padding: calc(1px / var(--table-zoom)) calc(3px / var(--table-zoom));
  white-space: nowrap;
  pointer-events: none;
  animation: restPulse 2.5s ease-in-out infinite;
  z-index: 3;
  min-font-size: 5px;
}
@keyframes restPulse {
  0%,100% { opacity: 1; }
  50%      { opacity: 0.55; }
}

/* Improved note-only chip */
.note-only-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 5px auto 3px;
  padding: 4px 5px;
  border-radius: 6px;
  background: rgba(245,158,11,0.13);
  border: 1.5px dashed rgba(245,158,11,0.6);
  width: 46px;
  cursor: pointer;
  transition: background var(--transition), border-color var(--transition), transform var(--transition);
  gap: 1px;
  box-shadow: 0 1px 4px rgba(245,158,11,0.15);
}
.note-only-chip:hover {
  background: rgba(245,158,11,0.24);
  border-color: rgba(245,158,11,0.9);
  transform: scale(1.05);
}
.note-only-icon {
  font-size: 11px;
  color: #d97706;
  line-height: 1;
}
.note-only-text {
  font-size: 7px;
  color: #92400e;
  font-style: italic;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 40px;
  text-align: center;
  line-height: 1.2;
}
.note-only-cell { min-height: 64px; }
[data-theme="dark"] .note-only-chip { background: rgba(245,158,11,0.14); border-color: rgba(245,158,11,0.5); }
[data-theme="dark"] .note-only-icon { color: #fbbf24; }
[data-theme="dark"] .note-only-text  { color: #fcd34d; }

/* Employee cell context menu trigger */
.employee-cell { cursor: context-menu; }
.emp-fill-hint {
  font-size: 9px;
  color: var(--text3);
  letter-spacing: 0;
  opacity: 0;
  transition: opacity var(--transition);
  line-height: 1;
  margin-top: 2px;
}
.employee-cell:hover .emp-fill-hint { opacity: 1; }

/* Footer rows */
.footer-row td {
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  font-size: 11px;
  text-align: center;
  vertical-align: middle;
  padding: 6px 4px;
  border-top: 1.5px solid var(--border);
  font-family: 'Space Mono', monospace;
  font-weight: 600;
  color: var(--text);
}
.footer-label {
  text-align: left !important;
  padding-left: 12px !important;
  font-family: 'DM Sans', sans-serif !important;
  font-size: 12px !important;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.footer-count { color: var(--text); }
.footer-count.zero { color: var(--text3); }

/* ==========================================
   MODALS
   ========================================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10,12,24,0.55);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
  backdrop-filter: blur(8px);
}
.modal-overlay.visible {
  opacity: 1;
  pointer-events: all;
}
.modal {
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 26px;
  min-width: 360px;
  max-width: 92vw;
  max-height: 87vh;
  overflow-y: auto;
  box-shadow: var(--shadow-glass);
  transform: scale(0.94) translateY(8px);
  transition: transform 0.25s cubic-bezier(.34,1.56,.64,1);
}
.modal-overlay.visible .modal { transform: scale(1) translateY(0); }
.modal-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-close {
  margin-left: auto;
  background: var(--glass2);
  border: 1px solid var(--border);
  color: var(--text3);
  cursor: pointer;
  font-size: 18px;
  padding: 2px 8px;
  border-radius: 8px;
  transition: all var(--transition);
  line-height: 1.4;
}
.modal-close:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }

.form-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 16px;
}
.form-row label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}
.form-row input, .form-row select, .form-row textarea {
  padding: 9px 13px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  outline: none;
  transition: border-color var(--transition), box-shadow var(--transition);
}
.form-row input:focus, .form-row select:focus, .form-row textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(91,127,255,0.15);
}
.form-row textarea { resize: vertical; min-height: 60px; }
.form-row input[type="range"] {
  padding: 4px 0;
  border: none;
  background: none;
  -webkit-appearance: none;
  width: 100%;
  backdrop-filter: none;
}
.form-row input[type="range"]::-webkit-slider-track {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
}
.form-row input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  cursor: pointer;
  margin-top: -6px;
  box-shadow: 0 2px 8px rgba(91,127,255,0.4);
}

.btn-row {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.btn {
  padding: 9px 18px;
  border: 1px solid transparent;
  border-radius: var(--radius);
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  transition: all var(--transition);
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 3px 12px rgba(91,127,255,0.35);
}
.btn-primary:hover { box-shadow: 0 5px 18px rgba(91,127,255,0.5); transform: translateY(-1px); }
.btn-secondary {
  background: var(--glass2);
  color: var(--text2);
  border-color: var(--border);
  backdrop-filter: var(--blur-sm);
}
.btn-secondary:hover { background: var(--glass); border-color: var(--accent); color: var(--accent); }
.btn-danger { background: rgba(239,68,68,0.1); color: #f87171; border-color: rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.2); }

/* Employee list in modal */
.emp-list { display: flex; flex-direction: column; gap: 5px; }
.emp-list-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 13px;
  border-radius: var(--radius);
  background: var(--glass2);
  border: 1.5px solid var(--border);
  cursor: pointer;
  transition: all var(--transition);
  backdrop-filter: var(--blur-sm);
}
.emp-list-item:hover { border-color: var(--accent); background: var(--accent-light); }
.emp-list-item .drag-handle {
  color: var(--text3);
  cursor: grab;
  font-size: 16px;
}
.emp-list-item .emp-info { flex: 1; }
.emp-list-item .emp-info .name { font-weight: 600; font-size: 13px; }
.emp-list-item .emp-info .role { font-size: 11px; color: var(--text3); }
.emp-list-item .emp-actions { display: flex; gap: 4px; }
.emp-list-item .icon-btn {
  width: 27px; height: 27px;
  border: 1px solid var(--border);
  background: var(--glass2);
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text3);
  transition: all var(--transition);
}
.emp-list-item .icon-btn:hover { background: var(--glass); border-color: var(--text3); color: var(--text); }
.icon-btn.danger:hover { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.4); color: #f87171; }

/* Shift config */
.shift-config-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 13px;
  border-radius: var(--radius);
  border: 1.5px solid var(--border);
  margin-bottom: 6px;
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  cursor: grab;
  transition: all var(--transition);
}
.shift-config-item:hover { border-color: var(--accent); }
.shift-config-item.dragging-shift-cfg { opacity: 0.4; }
.shift-config-item.drag-over-shift-cfg { box-shadow: 0 0 0 2px var(--accent); }
.shift-preview {
  width: 38px; height: 32px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 11px;
  font-family: 'Space Mono', monospace;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2);
}
.shift-cfg-drag { color: var(--text3); cursor: grab; font-size: 16px; flex-shrink: 0; }
.shift-config-inputs { flex: 1; display: flex; gap: 5px; align-items: center; }
.shift-config-inputs input {
  padding: 5px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--glass);
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
  outline: none;
  transition: border-color var(--transition);
}
.shift-config-inputs input:focus { border-color: var(--accent); }
.shift-config-inputs input.label-inp  { width: 46px; }
.shift-config-inputs input.name-inp   { flex: 1; }
.shift-config-inputs input.hours-inp  { width: 46px; }
.shift-config-inputs input.color-inp  { width: 32px; height: 28px; padding: 2px; cursor: pointer; border-radius: 5px; }

/* Settings toggles */
.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 7px;
}
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 13px;
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  border-radius: var(--radius);
  border: 1.5px solid var(--border);
}
.toggle-label { font-size: 13px; font-weight: 500; color: var(--text); }
.toggle-switch {
  position: relative;
  width: 36px; height: 20px;
}
.toggle-switch input { display: none; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  top: 3px; left: 3px;
  background: white;
  border-radius: 50%;
  transition: transform 0.2s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }

/* Context menu ‚Äì glass */
#context-menu, #emp-context-menu {
  position: fixed;
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 13px;
  padding: 6px;
  z-index: 3000;
  box-shadow: var(--shadow-lg);
  display: none;
  min-width: 210px;
}
#context-menu.visible, #emp-context-menu.visible { display: block; }
.ctx-item {
  padding: 8px 13px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text);
  transition: background var(--transition);
}
.ctx-item:hover { background: var(--glass2); }
.ctx-item.danger { color: #f87171; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.12); }
.ctx-divider { height: 1px; background: var(--border); margin: 4px 0; }

/* Toast ‚Äì glass */
#toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--glass);
  backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  color: var(--text);
  padding: 10px 22px;
  border-radius: 40px;
  font-size: 13px;
  font-weight: 600;
  z-index: 9999;
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1), opacity 0.3s;
  opacity: 0;
  pointer-events: none;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 8px;
}
#toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* Loading ‚Äì glass */
#loading {
  position: fixed;
  inset: 0;
  background: var(--bg);
  background-image: var(--bg-mesh);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  transition: opacity 0.5s;
}
#loading.hidden { opacity: 0; pointer-events: none; }
.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-right-color: var(--accent2);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Note popup ‚Äì glass */
.note-popup {
  position: fixed;
  background: var(--glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 14px;
  z-index: 2000;
  box-shadow: var(--shadow-lg);
  min-width: 220px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.25s cubic-bezier(.34,1.56,.64,1);
  transform: scale(0.92);
}
.note-popup.visible { opacity: 1; pointer-events: all; transform: scale(1); }
.note-popup textarea {
  width: 100%;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 7px 10px;
  font-family: inherit;
  font-size: 12px;
  background: var(--glass2);
  color: var(--text);
  resize: none;
  outline: none;
  transition: border-color var(--transition);
  backdrop-filter: var(--blur-sm);
}
.note-popup textarea:focus { border-color: var(--accent); }
.note-popup .note-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: flex-end; }
.note-popup .note-actions button {
  padding: 5px 11px;
  border: 1px solid transparent;
  border-radius: 7px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  font-family: inherit;
  transition: all var(--transition);
}

/* Drag & Drop */
.emp-row.drag-over td { background: var(--accent-light) !important; outline: 2px solid var(--accent); outline-offset: -2px; }
.emp-row.dragging { opacity: 0.35; }

/* ==========================================
   WEEK VIEW CONTROLS
   ========================================== */
#week-controls {
  display: none;
  align-items: center;
  gap: 8px;
}
#week-controls.visible { display: flex; }
.week-nav-btn {
  padding: 5px 11px;
  border: 1px solid var(--header-border);
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.8);
  border-radius: 7px;
  cursor: pointer;
  font-family: inherit;
  font-size: 11px;
  font-weight: 600;
  transition: all var(--transition);
}
.week-nav-btn:hover { background: rgba(255,255,255,0.16); }
.week-label { font-size: 12px; color: rgba(255,255,255,0.6); min-width: 110px; text-align: center; }

/* ==========================================
   YEAR VIEW OVERLAY
   ========================================== */
#year-overlay {
  position: fixed;
  inset: 0;
  background: rgba(8,10,22,0.65);
  backdrop-filter: blur(20px) saturate(1.5);
  -webkit-backdrop-filter: blur(20px) saturate(1.5);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#year-overlay.visible { opacity: 1; pointer-events: all; }

.year-panel {
  background: var(--glass);
  backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 28px 32px;
  box-shadow: var(--shadow-lg);
  width: min(680px, 95vw);
  transform: scale(0.92) translateY(20px);
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
}
#year-overlay.visible .year-panel { transform: scale(1) translateY(0); }

.year-panel-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
}
.year-nav-btn {
  width: 34px; height: 34px;
  border: 1px solid var(--border);
  background: var(--glass2);
  color: var(--text);
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.year-nav-btn:hover { background: var(--accent-light); border-color: var(--accent); }
.year-heading {
  font-size: 22px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  color: var(--text);
  flex: 1;
  text-align: center;
  letter-spacing: 2px;
}
.year-close-btn {
  width: 34px; height: 34px;
  border: 1px solid var(--border);
  background: var(--glass2);
  color: var(--text3);
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--transition);
}
.year-close-btn:hover { background: rgba(239,68,68,0.15); color: #f87171; border-color: rgba(239,68,68,0.3); }

.year-months-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.year-month-card {
  border-radius: 14px;
  border: 1.5px solid var(--border);
  background: var(--glass2);
  backdrop-filter: var(--blur-sm);
  cursor: pointer;
  padding: 12px 10px;
  text-align: center;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}
.year-month-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  opacity: 0;
  transition: opacity var(--transition);
  border-radius: inherit;
}
.year-month-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(91,127,255,0.2); }
.year-month-card:hover::before { opacity: 0.08; }
.year-month-card.current-month { border-color: var(--accent); background: var(--accent-light); }
.year-month-card.current-month::before { opacity: 0.12; }
.year-month-name {
  font-weight: 700;
  font-size: 13px;
  color: var(--text);
  position: relative;
  z-index: 1;
  letter-spacing: 0.3px;
}
.year-month-days {
  font-size: 10px;
  color: var(--text3);
  margin-top: 2px;
  font-family: 'Space Mono', monospace;
  position: relative;
  z-index: 1;
}
.year-month-card.current-month .year-month-name { color: var(--accent); }

/* Mini calendar in year card */
.mini-cal {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  margin-top: 6px;
  position: relative;
  z-index: 1;
}
.mini-cal-day {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 2px;
  font-size: 6.5px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Space Mono', monospace;
  color: var(--text3);
  font-weight: 600;
}
.mini-cal-day.has-shifts { background: var(--accent); color: white; border-radius: 3px; }
.mini-cal-day.weekend   { color: rgba(248,113,113,0.7); }
.mini-cal-day.holiday   { background: rgba(248,113,113,0.2); color: #f87171; border-radius: 3px; }
.mini-cal-day.empty     { opacity: 0; }

/* ==========================================
   PRINT STYLES
   ========================================== */
@media print {
  body { background: white; overflow: visible; display: block; }
  body::before { display: none; }
  #header, #sidebar, .modal-overlay, #loading, #toast, #year-overlay { display: none !important; }
  #main { display: block; overflow: visible; }
  #table-container { overflow: visible; padding: 0; }
  #plan-wrapper { box-shadow: none; border-radius: 0; overflow: visible; background: white !important; backdrop-filter: none; }
  #plan-table { font-size: 9px !important; transform: none !important; }
  #plan-table thead th { background: #1a1d2e !important; }
  #plan-table td, #plan-table th { padding: 2px 3px !important; }
  .shift-badge { width: 28px !important; height: 22px !important; font-size: 9px !important; }
  .day-cell { min-width: 32px !important; width: 32px !important; }
  @page { size: A3 landscape; margin: 8mm; }
}
</style>
</head>

<body data-theme="light">

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--text2);font-weight:600;letter-spacing:0.3px;">Dienstplan wird geladen‚Ä¶</div>
</div>

<!-- TOAST -->
<div id="toast">‚úì Gespeichert</div>

<!-- TOOLTIP -->
<div class="tooltip-box" id="tooltip"></div>

<!-- YEAR OVERLAY -->
<div id="year-overlay" onclick="if(event.target===this)closeYearView()">
  <div class="year-panel">
    <div class="year-panel-header">
      <button class="year-nav-btn" onclick="changeYearView(-1)">‚Äπ</button>
      <div class="year-heading" id="year-heading">2026</div>
      <button class="year-nav-btn" onclick="changeYearView(1)">‚Ä∫</button>
      <button class="year-close-btn" onclick="closeYearView()">√ó</button>
    </div>
    <div class="year-months-grid" id="year-months-grid"></div>
  </div>
</div>

<!-- NOTE POPUP -->
<div class="note-popup" id="note-popup">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <span id="note-popup-badge" style="display:inline-flex;align-items:center;justify-content:center;width:30px;height:24px;border-radius:5px;font-weight:700;font-size:10px;font-family:'Space Mono',monospace;flex-shrink:0;"></span>
    <div>
      <div style="font-size:11px;font-weight:700;color:var(--text);" id="note-popup-name"></div>
      <div style="font-size:10px;color:var(--text3);" id="note-popup-date"></div>
    </div>
  </div>
  <textarea id="note-textarea" rows="3" placeholder="Notiz eingeben‚Ä¶ (z.B. Wunsch, Tausch, Info)"></textarea>
  <div class="note-actions">
    <button id="note-delete" style="background:var(--surface2);color:#ef4444;border:1px solid #fecaca;">üóë L√∂schen</button>
    <button id="note-cancel" style="background:var(--surface2);color:var(--text2);">Abbrechen</button>
    <button id="note-save" style="background:var(--accent);color:white;">‚úì Speichern</button>
  </div>
</div>

<!-- CONTEXT MENU (day cells) -->
<div id="context-menu">
  <div class="ctx-item" id="ctx-note">‚úèÔ∏è Notiz bearbeiten</div>
  <div class="ctx-item" id="ctx-swap">üîÑ Zum Tauschen ausschreiben</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" id="ctx-clear" style="color:#ef4444">üóëÔ∏è Dienst l√∂schen</div>
</div>

<!-- CONTEXT MENU (employee name) -->
<div id="emp-context-menu">
  <div style="padding:7px 13px 5px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.7px;" id="emp-ctx-label">Mitarbeiter</div>
  <div class="ctx-divider" style="margin:2px 0 4px"></div>
  <div class="ctx-item" id="emp-ctx-fill">üñäÔ∏è Alle leeren Werktage ausf√ºllen</div>
  <div class="ctx-item" id="emp-ctx-fill-all">üìã Alle leeren Tage ausf√ºllen (inkl. WE)</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" id="emp-ctx-clear-month" style="color:#f87171">üóëÔ∏è Ganzen Monat l√∂schen</div>
</div>

<!-- ============================================================
     HEADER
     ============================================================ -->
<div id="header">
  <div class="logo">
    <div class="logo-icon">üìã</div>
    <div class="logo-text">
      <div class="logo-title">Dienstplan PRO</div>
      <div class="logo-sub">Helios Duisburg</div>
    </div>
  </div>

  <div class="header-divider"></div>

  <div class="view-toggle">
    <button class="view-btn active" id="btn-month" onclick="setView('month')">MONAT</button>
    <button class="view-btn" id="btn-week" onclick="setView('week')">WOCHE</button>
    <button class="view-btn" id="btn-year" onclick="openYearView()" title="Jahres√ºbersicht">JAHR</button>
  </div>

  <div class="month-nav">
    <button onclick="changeMonth(-1)" title="Vorheriger Monat">&#8249;</button>
    <div class="month-label" id="month-label" onclick="openYearView()" title="Jahres√ºbersicht √∂ffnen">APRIL 2026</div>
    <button onclick="changeMonth(1)" title="N√§chster Monat">&#8250;</button>
  </div>

  <div id="week-controls">
    <button class="week-nav-btn" onclick="changeWeek(-1)">&#8249;</button>
    <span class="week-label" id="week-label">KW 14</span>
    <button class="week-nav-btn" onclick="changeWeek(1)">&#8250;</button>
  </div>

  <div class="header-divider"></div>

  <div class="zoom-control">
    <button onclick="adjustZoom(-0.1)" title="Verkleinern">‚àí</button>
    <input type="range" class="zoom-slider" id="zoom-slider" min="0.5" max="1.5" step="0.05" value="1" oninput="setZoom(+this.value)">
    <button onclick="adjustZoom(0.1)" title="Vergr√∂√üern">+</button>
    <span class="zoom-label" id="zoom-label">100%</span>
  </div>

  <div class="workdays-badge" id="workdays-badge">20 Arbeitstage</div>

  <div class="header-spacer"></div>

  <div class="sync-badge offline" id="sync-badge">
    <div class="sync-dot"></div>
    <span id="sync-text">Lokal</span>
  </div>

  <button class="header-btn" id="lock-btn" onclick="toggleLock()" title="Edit-Modus sperren/entsperren">üîì</button>
  <button class="header-btn" onclick="openModal('modal-employees')" title="Mitarbeiter verwalten">üë•</button>
  <button class="header-btn" onclick="openModal('modal-shifts')" title="Dienste konfigurieren">‚öôÔ∏è</button>
  <button class="header-btn" onclick="openModal('modal-settings')" title="Einstellungen">‚ò∞</button>
  <button class="header-btn" onclick="openStatsModal()" title="Monatsstatistik">üìä</button>
  <button class="header-btn" id="theme-btn" onclick="toggleTheme()" title="Dark/Light Mode">üåô</button>

  <button class="export-btn" onclick="printPDF()">üìÑ Export</button>
  <button class="save-btn" onclick="saveAll()">üíæ Sichern</button>
</div>

<!-- ============================================================
     MAIN
     ============================================================ -->
<div id="main">

  <!-- SIDEBAR -->
  <div id="sidebar" id="shift-sidebar">
    <!-- filled by JS -->
  </div>

  <!-- TABLE AREA -->
  <div id="table-container">
    <div id="plan-wrapper">
      <table id="plan-table">
        <thead id="plan-thead"></thead>
        <tbody id="plan-tbody"></tbody>
        <tfoot id="plan-tfoot"></tfoot>
      </table>
    </div>
  </div>

</div>

<!-- ============================================================
     MODAL: EMPLOYEES
     ============================================================ -->
<div class="modal-overlay" id="modal-employees">
  <div class="modal" style="min-width:480px">
    <div class="modal-title">
      üë• Mitarbeiter verwalten
      <button class="modal-close" onclick="closeModal('modal-employees')">√ó</button>
    </div>
    <div id="emp-list-container" class="emp-list"></div>
    <div class="btn-row" style="margin-top:12px;justify-content:flex-start">
      <button class="btn btn-primary" onclick="openAddEmployee()">+ Mitarbeiter hinzuf√ºgen</button>
    </div>
  </div>
</div>

<!-- MODAL: ADD/EDIT EMPLOYEE -->
<div class="modal-overlay" id="modal-edit-employee">
  <div class="modal">
    <div class="modal-title">
      <span id="emp-edit-title">Mitarbeiter hinzuf√ºgen</span>
      <button class="modal-close" onclick="closeModal('modal-edit-employee')">√ó</button>
    </div>
    <div class="form-row">
      <label>Name (Nachname, Vorname)</label>
      <input type="text" id="emp-name-input" placeholder="MUSTERMANN, MAX">
    </div>
    <div class="form-row">
      <label>Rolle / Funktion</label>
      <select id="emp-role-input">
        <option>Stationsleitung</option>
        <option>Stellv. Leitung</option>
        <option>Fachkraft</option>
        <option>Pflegekraft</option>
        <option>Azubi</option>
        <option>Praktikant</option>
        <option>Hilfskraft</option>
      </select>
    </div>
    <div class="form-row">
      <label>Stellenanteil (VZ): <span id="vz-display">100%</span></label>
      <input type="range" id="emp-vz-input" min="10" max="100" step="5" value="100"
        oninput="document.getElementById('vz-display').textContent=this.value+'%'">
    </div>
    <div class="form-row">
      <label>√úbertrag Vormonat (Stunden)</label>
      <input type="number" id="emp-vmt-input" value="0" step="0.5">
    </div>
    <input type="hidden" id="emp-edit-id">
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-edit-employee')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveEmployee()">Speichern</button>
    </div>
  </div>
</div>

<!-- MODAL: SHIFT TYPES CONFIG -->
<div class="modal-overlay" id="modal-shifts">
  <div class="modal" style="min-width:520px">
    <div class="modal-title">
      ‚öôÔ∏è Dienste konfigurieren
      <button class="modal-close" onclick="closeModal('modal-shifts')">√ó</button>
    </div>
    <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">
      K√ºrzel ¬∑ Name ¬∑ Stunden ¬∑ Farbe (Text) ¬∑ Hintergrund
    </div>
    <div id="shift-config-list"></div>
    <div class="btn-row" style="justify-content:flex-start;margin-top:8px">
      <button class="btn btn-secondary" onclick="addShiftType()">+ Dienst hinzuf√ºgen</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-shifts')">Abbrechen</button>
      <button class="btn btn-primary" onclick="saveShiftConfig()">Speichern</button>
    </div>
  </div>
</div>

<!-- MODAL: SETTINGS -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal" style="min-width:420px">
    <div class="modal-title">
      ‚ò∞ Einstellungen
      <button class="modal-close" onclick="closeModal('modal-settings')">√ó</button>
    </div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Spalten anzeigen</div>
    <div class="settings-grid" id="col-toggles"></div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">Fu√üzeile Dienste z√§hlen</div>
    <div id="footer-toggles" style="display:flex;flex-wrap:wrap;gap:6px;"></div>

    <div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">Stundenfaktor</div>
    <div class="form-row" style="margin-bottom:0">
      <input type="number" id="hour-factor-input" value="7.7" step="0.1" min="1" max="12">
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-settings')">Schlie√üen</button>
      <button class="btn btn-primary" onclick="applySettings()">√úbernehmen</button>
    </div>
  </div>
</div>

<!-- MODAL: MONATSSTATISTIK -->
<div class="modal-overlay" id="modal-stats">
  <div class="modal" style="min-width:560px;max-width:700px">
    <div class="modal-title">
      üìä Monatsstatistik ‚Äì <span id="stats-month-label"></span>
      <button class="modal-close" onclick="closeModal('modal-stats')">√ó</button>
    </div>
    <div id="stats-content"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modal-stats')">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
// =============================================================================
// STATE
// =============================================================================
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth(); // 0-indexed
let currentView = 'month'; // 'month' | 'week'
let currentWeek = 1; // 1-based week within month
let currentZoom = 1;
let editLocked = false;
let darkMode = false;
let selectedShift = 'FD';
let contextTarget = null; // {empId, dateStr}

let settings = {
  cols: { vz: true, soll: true, ist: true, diff: true, vmt: true },
  footerShifts: {},
  hourFactor: 7.7
};

let shiftTypes = [
  { id: 'FD', label: 'FD', name: 'Fr√ºhdienst',   hours: 7.7, color: '#ffffff', bg: '#0ea5e9' },
  { id: 'SD', label: 'SD', name: 'Sp√§tdienst',   hours: 7.7, color: '#ffffff', bg: '#d946ef' },
  { id: 'ND', label: 'ND', name: 'Nachtdienst',  hours: 10,  color: '#ffffff', bg: '#f97316' },
  { id: 'ZD', label: 'ZD', name: 'Zwischendienst',hours: 7.7,color: '#ffffff', bg: '#7c3aed' },
  { id: 'ST', label: 'ST', name: 'Sp√§tteam',     hours: 7.7, color: '#ffffff', bg: '#2563eb' },
  { id: 'U',  label: 'U',  name: 'Urlaub',        hours: 0,   color: '#92400e', bg: '#fef3c7' },
  { id: 'K',  label: 'K',  name: 'Krank',         hours: 0,   color: '#ffffff', bg: '#ef4444' },
  { id: 'LT', label: 'LT', name: 'Langzeit',      hours: 7.7, color: '#ffffff', bg: '#10b981' },
  { id: 'X',  label: 'X',  name: 'Frei',          hours: 0,   color: '#64748b', bg: '#f1f5f9' },
];

let employees = [
  { id: 'e1',  name: 'ADAMS, HENDRIK',     role: 'Stationsleitung',  vz: 100, vmt: 0 },
  { id: 'e2',  name: 'FUCHSA, JENNIFER',   role: 'Stellv. Leitung',  vz: 100, vmt: 0 },
  { id: 'e3',  name: 'G√úNTER, STEPHANIE',  role: 'Fachkraft',        vz: 100, vmt: 0 },
  { id: 'e4',  name: 'BLANK, ALEXANDRA',   role: 'Fachkraft',        vz: 100, vmt: 0 },
  { id: 'e5',  name: 'FRIEDRICH, KRISTINA',role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e6',  name: 'WEIENBERG, HANNA',   role: 'Fachkraft',        vz: 100, vmt: 0 },
  { id: 'e7',  name: 'HACKMANN, MATTHIAS', role: 'Fachkraft',        vz: 90,  vmt: 0 },
  { id: 'e8',  name: 'BUCHM√úLLER, J√ñRG',   role: 'Fachkraft',        vz: 100, vmt: 0 },
  { id: 'e9',  name: 'R√ñSKEN, KATRIN',     role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e10', name: 'THEISSEN, JENNIFER', role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e11', name: 'DANIELS, JUSTIN',    role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e12', name: 'KAYMAZ, MELDA',      role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e13', name: 'K√úHN, PHILIPP',      role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e14', name: 'STRACHANSKI, JULIA', role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e15', name: 'PREUSSNER, PAULINE', role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e16', name: 'BIELOK, LARA',       role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e17', name: 'W√úSTKAMP, BIANCA',   role: 'Pflegekraft',      vz: 100, vmt: 0 },
  { id: 'e18', name: 'BONDZAU, MARTINA',   role: 'Pflegekraft',      vz: 100, vmt: 0 },
];

// shifts[empId][dateStr] = {type:'FD', note:''}
let shifts = {};

// =============================================================================
// HOLIDAYS (NRW)
// =============================================================================
function getNRWHolidays(year) {
  // Easter calculation (Gauss)
  const a = year % 19, b = Math.floor(year / 100), c = year % 100;
  const d = Math.floor(b / 4), e = b % 4;
  const f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4), k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31);
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  const easter = new Date(year, month - 1, day);

  function addDays(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
  }
  function fmt(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  const h_fixed = {
    [`${year}-01-01`]: 'Neujahr',
    [`${year}-05-01`]: 'Tag der Arbeit',
    [`${year}-10-03`]: 'Tag der Deutschen Einheit',
    [`${year}-11-01`]: 'Allerheiligen',
    [`${year}-12-25`]: '1. Weihnachtstag',
    [`${year}-12-26`]: '2. Weihnachtstag',
  };
  const h_movable = {
    [fmt(addDays(easter, -2))]:  'Karfreitag',
    [fmt(easter)]:               'Ostersonntag',
    [fmt(addDays(easter, 1))]:   'Ostermontag',
    [fmt(addDays(easter, 39))]:  'Christi Himmelfahrt',
    [fmt(addDays(easter, 49))]:  'Pfingstsonntag',
    [fmt(addDays(easter, 50))]:  'Pfingstmontag',
    [fmt(addDays(easter, 60))]:  'Fronleichnam',
  };
  return { ...h_fixed, ...h_movable };
}

// =============================================================================
// DATE HELPERS
// =============================================================================
const DAYS_DE = ['SO','MO','DI','MI','DO','FR','SA'];
const MONTHS_DE = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

function daysInMonth(y, m) { return new Date(y, m+1, 0).getDate(); }

function dateStr(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function isWeekend(y, m, d) {
  const dow = new Date(y, m, d).getDay();
  return dow === 0 || dow === 6;
}

function isToday(y, m, d) {
  const t = new Date();
  return t.getFullYear() === y && t.getMonth() === m && t.getDate() === d;
}

function getWorkdays(y, m) {
  const hols = getNRWHolidays(y);
  let count = 0;
  for (let d = 1; d <= daysInMonth(y, m); d++) {
    const ds = dateStr(y, m, d);
    const dow = new Date(y, m, d).getDay();
    if (dow >= 1 && dow <= 5 && !hols[ds]) count++;
  }
  return count;
}

function calcSoll(vz, workdays, hourFactor) {
  return Math.round(workdays * hourFactor * (vz / 100) * 10) / 10;
}

function calcIst(empId, y, m) {
  const empShifts = shifts[empId] || {};
  let total = 0;
  for (let d = 1; d <= daysInMonth(y, m); d++) {
    const ds = dateStr(y, m, d);
    if (empShifts[ds] && empShifts[ds].type) {
      const st = shiftTypes.find(s => s.id === empShifts[ds].type);
      if (st) total += st.hours;
    }
  }
  return Math.round(total * 10) / 10;
}

// =============================================================================
// GET VISIBLE DAYS (month or week)
// =============================================================================
function getVisibleDays() {
  const total = daysInMonth(currentYear, currentMonth);
  if (currentView === 'month') {
    return Array.from({length: total}, (_, i) => i+1);
  } else {
    // Week: 7 days per week, starting Monday of currentWeek
    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstDow = firstDay.getDay(); // 0=Sun
    // Days in current month, grouped by ISO week
    const weeks = [];
    let week = [];
    for (let d = 1; d <= total; d++) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow === 1 && week.length > 0) { weeks.push(week); week = []; }
      week.push(d);
    }
    if (week.length > 0) weeks.push(week);
    const wk = weeks[Math.min(currentWeek-1, weeks.length-1)] || weeks[0];
    updateWeekLabel(wk);
    return wk;
  }
}

function getWeeksInMonth() {
  const total = daysInMonth(currentYear, currentMonth);
  const weeks = [];
  let week = [];
  for (let d = 1; d <= total; d++) {
    const dow = new Date(currentYear, currentMonth, d).getDay();
    if (dow === 1 && week.length > 0) { weeks.push(week); week = []; }
    week.push(d);
  }
  if (week.length > 0) weeks.push(week);
  return weeks.length;
}

function updateWeekLabel(days) {
  if (!days || days.length === 0) return;
  const d1 = days[0], d2 = days[days.length-1];
  document.getElementById('week-label').textContent = `${d1}.‚Äì${d2}. ${MONTHS_DE[currentMonth].substring(0,3)}.`;
}

// =============================================================================
// RENDER
// =============================================================================
function render() {
  renderHeader();
  renderSidebar();
  renderTable();
  applyZoom();
}

function renderHeader() {
  document.getElementById('month-label').textContent =
    `${MONTHS_DE[currentMonth].toUpperCase()} ${currentYear}`;
  const wd = getWorkdays(currentYear, currentMonth);
  document.getElementById('workdays-badge').textContent = `${wd} Arbeitstage`;
}

function renderSidebar() {
  const sb = document.getElementById('sidebar');
  sb.innerHTML = '';
  let dragSrcId = null;

  shiftTypes.forEach(st => {
    const btn = document.createElement('button');
    btn.className = 'sidebar-shift-btn' + (selectedShift === st.id ? ' selected' : '');
    btn.style.background = st.bg;
    btn.style.color = st.color;
    btn.title = `${st.name} (${st.hours}h) ‚Äî Ziehen zum Sortieren`;
    btn.innerHTML = `${st.label}<span>${st.hours}h</span>`;
    btn.setAttribute('draggable', 'true');
    btn.dataset.id = st.id;

    btn.addEventListener('click', () => {
      selectedShift = st.id;
      renderSidebar();
    });

    // Drag reorder sidebar
    btn.addEventListener('dragstart', e => {
      dragSrcId = st.id;
      btn.classList.add('dragging-shift');
      e.dataTransfer.effectAllowed = 'move';
    });
    btn.addEventListener('dragend', () => btn.classList.remove('dragging-shift'));
    btn.addEventListener('dragover', e => { e.preventDefault(); btn.classList.add('drag-over-shift'); });
    btn.addEventListener('dragleave', () => btn.classList.remove('drag-over-shift'));
    btn.addEventListener('drop', e => {
      e.preventDefault();
      btn.classList.remove('drag-over-shift');
      const toId = st.id;
      if (!dragSrcId || dragSrcId === toId) return;
      const fromIdx = shiftTypes.findIndex(s => s.id === dragSrcId);
      const toIdx   = shiftTypes.findIndex(s => s.id === toId);
      const [moved] = shiftTypes.splice(fromIdx, 1);
      shiftTypes.splice(toIdx, 0, moved);
      dragSrcId = null;
      renderSidebar();
      saveLocal();
    });

    sb.appendChild(btn);
  });
}

function renderTable() {
  const holidays = getNRWHolidays(currentYear);
  const days = getVisibleDays();
  const thead = document.getElementById('plan-thead');
  const tbody = document.getElementById('plan-tbody');
  const tfoot = document.getElementById('plan-tfoot');

  // --- Pre-compute per-day counts for FD / SD / ND (for warnings) ---
  const WARN_SHIFTS = ['FD', 'SD', 'ND'];
  const MIN_STAFF = 2;
  const dayCounts = {}; // dayCounts[ds][shiftId] = count
  days.forEach(d => {
    const ds = dateStr(currentYear, currentMonth, d);
    dayCounts[ds] = {};
    WARN_SHIFTS.forEach(sid => {
      dayCounts[ds][sid] = employees.filter(emp =>
        shifts[emp.id]?.[ds]?.type === sid
      ).length;
    });
  });

  // --- THEAD ---
  let thHTML = '<tr>';
  thHTML += `<th class="stat-th emp-th" style="left:0"><div class="th-inner th-employee" style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.5)">Mitarbeiter</div></th>`;

  let statLeft = 150;
  const statCols = [
    {key:'vz', label:'VZ'},
    {key:'soll', label:'Soll'},
    {key:'ist', label:'Ist'},
    {key:'diff', label:'+/‚àí'},
    {key:'vmt', label:'Vmt'},
  ];
  statCols.forEach(col => {
    if (!settings.cols[col.key]) return;
    thHTML += `<th class="stat-th" style="left:${statLeft}px"><div class="th-inner col-stat">${col.label}</div></th>`;
    statLeft += 38;
  });

  days.forEach(d => {
    const ds = dateStr(currentYear, currentMonth, d);
    const dow = new Date(currentYear, currentMonth, d).getDay();
    const dayName = DAYS_DE[dow];
    const wknd = isWeekend(currentYear, currentMonth, d);
    const isHol = !!holidays[ds];
    const isTod = isToday(currentYear, currentMonth, d);
    let cls = '';
    if (isTod) cls = 'th-today';
    else if (isHol) cls = 'th-holiday';
    else if (wknd) cls = 'th-weekend';

    // Warning logic: ALL days (inkl. Wochenende & Feiertage)
    let warnHTML = '';
    const missingShifts = WARN_SHIFTS.filter(sid => (dayCounts[ds][sid] || 0) < MIN_STAFF);
    if (missingShifts.length > 0) {
      const hasCritical = missingShifts.some(sid => (dayCounts[ds][sid] || 0) === 0);
      const dotClass = hasCritical ? 'warn-dot critical' : 'warn-dot';
      const labelsHTML = missingShifts.map(sid => {
        const cnt = dayCounts[ds][sid] || 0;
        const isCrit = cnt === 0;
        return `<span class="warn-label${isCrit ? ' critical' : ''}" title="${sid}: nur ${cnt} von mind. 2">${sid}:${cnt}</span>`;
      }).join('');
      warnHTML = `<div class="warn-row"><div class="${dotClass}"></div>${labelsHTML}</div>`;
    }

    thHTML += `<th class="${cls}"><div class="th-inner">
      <div class="th-day-num">${d}</div>
      <div class="th-day-name">${dayName}</div>
      ${warnHTML}
    </div></th>`;
  });
  thHTML += '</tr>';
  thead.innerHTML = thHTML;

  // --- Compute sticky left positions ---
  const EMP_WIDTH = 150;
  const STAT_WIDTH = 44;
  let stickyLeftAcc = EMP_WIDTH;
  const statLeftMap = {};
  statCols.forEach(col => {
    statLeftMap[col.key] = stickyLeftAcc;
    if (settings.cols[col.key]) stickyLeftAcc += STAT_WIDTH;
  });

  // --- TBODY ---
  let tbHTML = '';
  employees.forEach((emp, idx) => {
    const workdays = getWorkdays(currentYear, currentMonth);
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    const diff = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const diffSign = diff >= 0 ? '+' : '';
    const diffClass = diff >= 0 ? 'positive' : 'negative';

    tbHTML += `<tr class="emp-row" data-empid="${emp.id}" draggable="${!editLocked}" 
      ondragstart="dragStart(event,'${emp.id}')"
      ondragover="dragOver(event)"
      ondrop="dropRow(event,'${emp.id}')"
      ondragend="dragEnd(event)">`;

    tbHTML += `<td class="employee-cell" 
      ondblclick="openEditEmployee('${emp.id}')"
      oncontextmenu="handleEmpContextMenu(event,'${emp.id}')">
      <div class="emp-name">${emp.name}</div>
      <div class="emp-role">${emp.role}</div>
      <div class="emp-fill-hint">Rechtsklick: Ausf√ºllen‚Ä¶</div>
    </td>`;

    if (settings.cols.vz)   tbHTML += `<td class="stat-cell stat-vz" style="position:sticky;left:${statLeftMap.vz}px">${emp.vz}%</td>`;
    if (settings.cols.soll) tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.soll}px">${soll}</td>`;
    if (settings.cols.ist)  tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.ist}px">${ist}</td>`;
    if (settings.cols.diff) tbHTML += `<td class="stat-cell ${diffClass}" style="position:sticky;left:${statLeftMap.diff}px">${diffSign}${diff}</td>`;
    if (settings.cols.vmt)  tbHTML += `<td class="stat-cell" style="position:sticky;left:${statLeftMap.vmt}px">${emp.vmt||0}</td>`;

    days.forEach(d => {
      const ds = dateStr(currentYear, currentMonth, d);
      const wknd = isWeekend(currentYear, currentMonth, d);
      const isHol = !!holidays[ds];
      const isTod = isToday(currentYear, currentMonth, d);
      let cls = 'day-cell';
      if (isTod) cls += ' today-col';
      else if (isHol) cls += ' holiday';
      else if (wknd) cls += ' weekend';

      const empShifts = shifts[emp.id] || {};
      const cell = empShifts[ds];
      const hasNote = !!(cell && cell.note && cell.note.trim());
      const hasShift = !!(cell && cell.type);
      let inner = '';

      // Note-edit pencil button (shown on hover via CSS)
      const noteEditBtn = editLocked ? '' :
        `<button class="note-edit-btn" onclick="event.stopPropagation();openNotePopup('${emp.id}','${ds}')" title="Notiz bearbeiten">‚úé</button>`;

      if (hasShift) {
        const st = shiftTypes.find(s => s.id === cell.type);
        if (st) {
          const noteDot = hasNote ? `<span class="note-dot"></span>` : '';
          const swapDot = cell.swap ? `<span class="swap-dot" title="Zum Tauschen ausgeschrieben">üîÑ</span>` : '';

          // ‚ö†Ô∏è Ruhezeit-Check: ND am Vortag + FD heute = <11h Ruhezeit (ArbZG ¬ß5)
          let restBadge = '';
          if (cell.type === 'FD') {
            // Vortag ermitteln (auch Monatsgrenzen ber√ºcksichtigen)
            let prevDs;
            if (d > 1) {
              prevDs = dateStr(currentYear, currentMonth, d - 1);
            } else {
              // Letzter Tag des Vormonats
              const pm = currentMonth === 0 ? 11 : currentMonth - 1;
              const py = currentMonth === 0 ? currentYear - 1 : currentYear;
              prevDs = dateStr(py, pm, daysInMonth(py, pm));
            }
            const prevCell = shifts[emp.id]?.[prevDs];
            if (prevCell?.type === 'ND') {
              restBadge = `<div class="rest-violation-badge" title="‚ö†Ô∏è Ruhezeitverletzung: ND dann FD ‚Äì weniger als 11h Ruhezeit! (ArbZG ¬ß5)">‚ö°11h</div>`;
            }
          }

          inner = `${noteEditBtn}<div class="shift-badge" style="background:${st.bg};color:${st.color}"
            onclick="handleCellClick(event,'${emp.id}','${ds}')"
            oncontextmenu="handleContextMenu(event,'${emp.id}','${ds}')"
            title="${escapeHTML(st.name)}${cell.note ? '\n‚úé '+escapeHTML(cell.note) : ''}${cell.swap ? '\nüîÑ Tauschen' : ''}${restBadge ? '\n‚ö° Ruhezeitverletzung ND‚ÜíFD <11h!' : ''}"
            >${st.label}${noteDot}${swapDot}</div>${restBadge}`;
          if (hasNote) {
            inner += `<div class="shift-note-tag" title="${escapeHTML(cell.note)}">
              <span class="shift-note-tag-text">${escapeHTML(cell.note)}</span>
            </div>`;
          }
        }
      } else {
        // Kein Dienst ‚Äì Notiz-Only-Chip falls Notiz vorhanden
        inner = noteEditBtn;
        if (hasNote) {
          inner += `<div class="note-only-chip"
            onclick="event.stopPropagation();openNotePopup('${emp.id}','${ds}')"
            oncontextmenu="event.stopPropagation();handleContextMenu(event,'${emp.id}','${ds}')"
            title="‚úé ${escapeHTML(cell.note)}">
            <span class="note-only-icon">‚úé</span>
            <span class="note-only-text">${escapeHTML(cell.note)}</span>
          </div>`;
        }
      }

      tbHTML += `<td class="${cls}${hasNote?' has-note':''}${(!hasShift&&hasNote)?' note-only-cell':''}"
        onclick="handleCellClick(event,'${emp.id}','${ds}')"
        ondblclick="event.stopPropagation();openNotePopup('${emp.id}','${ds}')"
        oncontextmenu="handleContextMenu(event,'${emp.id}','${ds}')"
        >${inner}</td>`;
    });

    tbHTML += '</tr>';
  });
  tbody.innerHTML = tbHTML;

  // --- TFOOT ---
  const footShifts = shiftTypes.filter(st => settings.footerShifts[st.id] !== false);
  let tfHTML = '';
  footShifts.forEach(st => {
    const visStatCols2 = statCols.filter(c => settings.cols[c.key]);
    const fColspan = 1 + visStatCols2.length;
    tfHTML += `<tr class="footer-row">`;
    tfHTML += `<td colspan="${fColspan}"><div class="footer-label">
      <span style="display:inline-block;width:22px;height:18px;border-radius:4px;background:${st.bg};color:${st.color};font-size:9px;font-weight:700;text-align:center;line-height:18px;font-family:'Space Mono',monospace">${st.label}</span>
      ${st.name}
    </div></td>`;

    days.forEach(d => {
      const ds = dateStr(currentYear, currentMonth, d);
      let count = 0;
      employees.forEach(emp => {
        if (shifts[emp.id] && shifts[emp.id][ds] && shifts[emp.id][ds].type === st.id) count++;
      });
      tfHTML += `<td class="footer-count${count===0?' zero':''}">${count}</td>`;
    });
    tfHTML += '</tr>';
  });
  tfoot.innerHTML = tfHTML;
}

// =============================================================================
// CELL INTERACTION
// =============================================================================
function handleCellClick(e, empId, ds) {
  e.stopPropagation();
  if (editLocked) return;
  // Don't trigger shift assignment when clicking note chip, pencil btn, or rest badge
  if (e.target.closest('.note-only-chip') ||
      e.target.closest('.note-edit-btn') ||
      e.target.closest('.rest-violation-badge')) return;
  if (!shifts[empId]) shifts[empId] = {};
  const current = shifts[empId][ds];

  if (current && current.type === selectedShift) {
    // Toggle off ‚Äì preserve note if it exists
    if (current.note && current.note.trim()) {
      shifts[empId][ds] = { type: '', note: current.note, swap: false };
    } else {
      delete shifts[empId][ds];
    }
  } else {
    shifts[empId][ds] = { type: selectedShift, note: current?.note || '', swap: current?.swap || false };
  }
  renderTable();
  saveLocal();
}

function handleContextMenu(e, empId, ds) {
  e.preventDefault();
  e.stopPropagation();
  contextTarget = { empId, ds };
  updateContextMenuForTarget(empId, ds);
  const menu = document.getElementById('context-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top  = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('emp-context-menu').classList.remove('visible');
}

// =============================================================================
// EMPLOYEE CONTEXT MENU (Rechtsklick auf Mitarbeiternamen)
// =============================================================================
let empContextTarget = null;

function handleEmpContextMenu(e, empId) {
  e.preventDefault();
  e.stopPropagation();
  empContextTarget = empId;
  const emp = employees.find(em => em.id === empId);
  document.getElementById('emp-ctx-label').textContent = emp ? emp.name : 'Mitarbeiter';
  const fillLabel = document.getElementById('emp-ctx-fill');
  const st = shiftTypes.find(s => s.id === selectedShift);
  const stLabel = st ? `"${st.label}" ‚Äì ${st.name}` : selectedShift;
  fillLabel.innerHTML = `üñäÔ∏è Werktage f√ºllen mit <strong style="color:var(--accent)">${stLabel}</strong>`;
  document.getElementById('emp-ctx-fill-all').innerHTML =
    `üìã Alle Tage f√ºllen mit <strong style="color:var(--accent)">${stLabel}</strong>`;
  const menu = document.getElementById('emp-context-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top  = e.clientY + 'px';
  menu.classList.add('visible');
  document.getElementById('context-menu').classList.remove('visible');
}

document.getElementById('emp-ctx-fill').onclick = () => {
  if (!empContextTarget || editLocked) return;
  fillEmployeeMonth(empContextTarget, false);
  document.getElementById('emp-context-menu').classList.remove('visible');
};
document.getElementById('emp-ctx-fill-all').onclick = () => {
  if (!empContextTarget || editLocked) return;
  fillEmployeeMonth(empContextTarget, true);
  document.getElementById('emp-context-menu').classList.remove('visible');
};
document.getElementById('emp-ctx-clear-month').onclick = () => {
  if (!empContextTarget || editLocked) return;
  if (!confirm(`Gesamten Monat f√ºr ${employees.find(e=>e.id===empContextTarget)?.name || ''} l√∂schen?`)) return;
  const total = daysInMonth(currentYear, currentMonth);
  if (!shifts[empContextTarget]) shifts[empContextTarget] = {};
  for (let d = 1; d <= total; d++) {
    const ds = dateStr(currentYear, currentMonth, d);
    delete shifts[empContextTarget][ds];
  }
  document.getElementById('emp-context-menu').classList.remove('visible');
  renderTable(); saveLocal();
  showToast('üóëÔ∏è Monat geleert');
};

function fillEmployeeMonth(empId, includeWeekends) {
  const holidays = getNRWHolidays(currentYear);
  const total = daysInMonth(currentYear, currentMonth);
  if (!shifts[empId]) shifts[empId] = {};
  let filled = 0;
  for (let d = 1; d <= total; d++) {
    const ds = dateStr(currentYear, currentMonth, d);
    const existing = shifts[empId][ds];
    if (existing && existing.type) continue; // bereits belegt ‚Üí √ºberspringen
    if (!includeWeekends) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow === 0 || dow === 6) continue; // Wochenende √ºberspringen
      if (holidays[ds]) continue; // Feiertag √ºberspringen
    }
    shifts[empId][ds] = { type: selectedShift, note: existing?.note || '', swap: false };
    filled++;
  }
  renderTable(); saveLocal();
  const st = shiftTypes.find(s => s.id === selectedShift);
  showToast(`‚úì ${filled} Tage mit ${st?.label || selectedShift} gef√ºllt`);
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('#emp-context-menu')) {
    document.getElementById('emp-context-menu').classList.remove('visible');
  }
});

document.getElementById('ctx-clear').onclick = () => {
  if (contextTarget && !editLocked) {
    const {empId, ds} = contextTarget;
    if (shifts[empId]) delete shifts[empId][ds];
    renderTable();
    saveLocal();
  }
  document.getElementById('context-menu').classList.remove('visible');
};

document.getElementById('ctx-note').onclick = () => {
  if (contextTarget) openNotePopup(contextTarget.empId, contextTarget.ds);
  document.getElementById('context-menu').classList.remove('visible');
};

document.getElementById('ctx-swap').onclick = () => {
  if (contextTarget && !editLocked) {
    const {empId, ds} = contextTarget;
    if (!shifts[empId]) shifts[empId] = {};
    if (!shifts[empId][ds]) shifts[empId][ds] = { type: '', note: '', swap: false };
    shifts[empId][ds].swap = !shifts[empId][ds].swap;
    const isNow = shifts[empId][ds].swap;
    renderTable();
    saveLocal();
    showToast(isNow ? 'üîÑ Als Tauschtag markiert' : '‚úì Tauschmarkierung entfernt');
  }
  document.getElementById('context-menu').classList.remove('visible');
};

// Update swap menu label based on current state
function updateContextMenuForTarget(empId, ds) {
  const swapItem = document.getElementById('ctx-swap');
  const isSwap = shifts[empId]?.[ds]?.swap;
  swapItem.textContent = isSwap ? '‚úì Tausch aufheben' : 'üîÑ Zum Tauschen ausschreiben';
}

document.addEventListener('click', () => {
  document.getElementById('context-menu').classList.remove('visible');
});

// =============================================================================
// NOTE POPUP
// =============================================================================
let noteTarget = null;

function openNotePopup(empId, ds) {
  if (editLocked) return;
  noteTarget = {empId, ds};
  const popup   = document.getElementById('note-popup');
  const ta      = document.getElementById('note-textarea');
  const badge   = document.getElementById('note-popup-badge');
  const nameEl  = document.getElementById('note-popup-name');
  const dateEl  = document.getElementById('note-popup-date');

  const existing = shifts[empId]?.[ds];
  ta.value = existing?.note || '';

  // Populate header
  const emp = employees.find(e => e.id === empId);
  nameEl.textContent = emp ? emp.name : '';
  const [y, m, d] = ds.split('-').map(Number);
  const dow = new Date(y, m-1, d).getDay();
  dateEl.textContent = `${DAYS_DE[dow]}, ${d}.${m}.${y}`;

  if (existing?.type) {
    const st = shiftTypes.find(s => s.id === existing.type);
    if (st) {
      badge.textContent = st.label;
      badge.style.background = st.bg;
      badge.style.color = st.color;
      badge.style.display = '';
    } else { badge.style.display = 'none'; }
  } else {
    badge.style.display = 'none';
  }

  // Position smart: near center, but check viewport edges
  popup.style.left = '50%';
  popup.style.top = '50%';
  popup.style.transform = 'translate(-50%,-50%) scale(0.95)';
  popup.classList.add('visible');
  popup.style.transform = 'translate(-50%,-50%) scale(1)';
  ta.focus();
  ta.select();
}

document.getElementById('note-save').onclick = () => {
  if (noteTarget) {
    const {empId, ds} = noteTarget;
    const note = document.getElementById('note-textarea').value.trim();
    if (!shifts[empId]) shifts[empId] = {};
    if (!shifts[empId][ds]) shifts[empId][ds] = { type: '', note: '' };
    shifts[empId][ds].note = note;
    renderTable();
    saveLocal();
    showToast('‚úé Notiz gespeichert');
  }
  document.getElementById('note-popup').classList.remove('visible');
};

document.getElementById('note-delete').onclick = () => {
  if (noteTarget) {
    const {empId, ds} = noteTarget;
    if (shifts[empId]?.[ds]) {
      shifts[empId][ds].note = '';
      renderTable();
      saveLocal();
    }
  }
  document.getElementById('note-popup').classList.remove('visible');
};

document.getElementById('note-cancel').onclick = () => {
  document.getElementById('note-popup').classList.remove('visible');
};

// =============================================================================
// ZOOM
// =============================================================================
function setZoom(val) {
  currentZoom = Math.min(1.5, Math.max(0.5, val));
  document.getElementById('zoom-slider').value = currentZoom;
  document.getElementById('zoom-label').textContent = Math.round(currentZoom*100) + '%';
  applyZoom();
}

function applyZoom() {
  const t = document.getElementById('plan-table');
  const w = document.getElementById('plan-wrapper');
  t.style.transform = `scale(${currentZoom})`;
  t.style.transformOrigin = 'top left';
  w.style.width = `${Math.round(currentZoom * 100)}%`;
  // Inject zoom as CSS var so warn-row elements scale proportionally
  document.documentElement.style.setProperty('--table-zoom', currentZoom);
}

function adjustZoom(delta) {
  setZoom(currentZoom + delta);
}

// =============================================================================
// VIEW & NAVIGATION
// =============================================================================
function setView(v) {
  currentView = v;
  document.getElementById('btn-month').classList.toggle('active', v === 'month');
  document.getElementById('btn-week').classList.toggle('active', v === 'week');
  document.getElementById('week-controls').classList.toggle('visible', v === 'week');
  currentWeek = 1;
  render();
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0)  { currentMonth = 11; currentYear--; }
  currentWeek = 1;
  render();
}

function changeWeek(delta) {
  const maxW = getWeeksInMonth();
  currentWeek = Math.max(1, Math.min(maxW, currentWeek + delta));
  render();
}

// =============================================================================
// YEAR VIEW
// =============================================================================
let yearViewYear = new Date().getFullYear();

function openYearView() {
  yearViewYear = currentYear;
  renderYearView();
  document.getElementById('year-overlay').classList.add('visible');
}

function closeYearView() {
  document.getElementById('year-overlay').classList.remove('visible');
}

function changeYearView(delta) {
  yearViewYear += delta;
  renderYearView();
}

function renderYearView() {
  document.getElementById('year-heading').textContent = yearViewYear;
  const hols = getNRWHolidays(yearViewYear);
  const grid = document.getElementById('year-months-grid');
  grid.innerHTML = '';

  for (let m = 0; m < 12; m++) {
    const card = document.createElement('div');
    card.className = 'year-month-card' +
      (m === currentMonth && yearViewYear === currentYear ? ' current-month' : '');
    card.title = `${MONTHS_DE[m]} ${yearViewYear} √∂ffnen`;

    const wd = getWorkdays(yearViewYear, m);
    const total = daysInMonth(yearViewYear, m);

    // Count total shifts this month across all employees
    let totalShifts = 0;
    employees.forEach(emp => {
      for (let d = 1; d <= total; d++) {
        const ds = dateStr(yearViewYear, m, d);
        if (shifts[emp.id]?.[ds]?.type) totalShifts++;
      }
    });

    // Build mini calendar
    const firstDow = new Date(yearViewYear, m, 1).getDay(); // 0=Sun
    const startOffset = (firstDow === 0) ? 6 : firstDow - 1; // Mon-start
    let miniHTML = '<div class="mini-cal">';
    // Day name headers
    ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d => {
      miniHTML += `<div class="mini-cal-day" style="color:var(--text3);font-weight:700">${d}</div>`;
    });
    // Empty cells
    for (let i = 0; i < startOffset; i++) {
      miniHTML += '<div class="mini-cal-day empty"></div>';
    }
    // Days
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(yearViewYear, m, d);
      const dow = new Date(yearViewYear, m, d).getDay();
      const isWknd = (dow === 0 || dow === 6);
      const isHol  = !!hols[ds];
      const hasShift = employees.some(emp => shifts[emp.id]?.[ds]?.type);
      let cls = 'mini-cal-day';
      if (hasShift) cls += ' has-shifts';
      else if (isHol) cls += ' holiday';
      else if (isWknd) cls += ' weekend';
      miniHTML += `<div class="${cls}">${d}</div>`;
    }
    miniHTML += '</div>';

    card.innerHTML = `
      <div class="year-month-name">${MONTHS_DE[m].substring(0,3).toUpperCase()}</div>
      <div class="year-month-days">${wd} Arbeitstage${totalShifts > 0 ? ' ¬∑ ' + totalShifts + ' Dienste' : ''}</div>
      ${miniHTML}
    `;

    card.addEventListener('click', () => {
      currentYear  = yearViewYear;
      currentMonth = m;
      currentWeek  = 1;
      setView('month');
      closeYearView();
    });

    grid.appendChild(card);
  }
}

// =============================================================================
// NEUE FUNKTION 1: MONATSSTATISTIK
// Warum: Die Leitung braucht auf Knopfdruck eine √úbersicht ‚Äì wer ist √ºber/unter Soll,
// wie viele Krankentage, Urlaubstage und Tausch-Markierungen gibt es diesen Monat.
// Das ist der t√§gl. Blick, den man sonst manuell zusammenrechnet.
// =============================================================================
function openStatsModal() {
  document.getElementById('stats-month-label').textContent =
    `${MONTHS_DE[currentMonth]} ${currentYear}`;
  renderStatsContent();
  openModal('modal-stats');
}

function renderStatsContent() {
  const cont = document.getElementById('stats-content');
  const workdays  = getWorkdays(currentYear, currentMonth);
  const total     = daysInMonth(currentYear, currentMonth);

  // Global summary
  let totalIst = 0, totalSoll = 0, sickDays = 0, vacDays = 0, swapCount = 0;
  employees.forEach(emp => {
    const soll = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist  = calcIst(emp.id, currentYear, currentMonth);
    totalIst  += ist;
    totalSoll += soll;
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const c  = shifts[emp.id]?.[ds];
      if (!c) continue;
      if (c.type === 'K') sickDays++;
      if (c.type === 'U') vacDays++;
      if (c.swap) swapCount++;
    }
  });

  const maxIst = Math.max(...employees.map(emp => calcIst(emp.id, currentYear, currentMonth)), 1);

  let html = `
  <div class="stats-summary">
    <div class="stats-card">
      <div class="stats-card-val">${Math.round(totalIst)}h</div>
      <div class="stats-card-lbl">Gesamt Ist</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val">${Math.round(totalSoll)}h</div>
      <div class="stats-card-lbl">Gesamt Soll</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val" style="color:#f87171">${sickDays}</div>
      <div class="stats-card-lbl">Krank-Tage</div>
    </div>
    <div class="stats-card">
      <div class="stats-card-val" style="color:#34d399">${vacDays}</div>
      <div class="stats-card-lbl">Urlaubstage</div>
    </div>
  </div>
  ${swapCount > 0 ? `<div style="margin-bottom:14px;padding:8px 12px;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:8px;font-size:12px;color:#06b6d4;">üîÑ ${swapCount} Tausch-Markierung${swapCount!==1?'en':''} diesen Monat</div>` : ''}
  <table class="stats-table">
    <thead>
      <tr>
        <th>Mitarbeiter</th>
        <th>VZ</th>
        <th>Soll</th>
        <th>Ist</th>
        <th style="min-width:90px">Auslastung</th>
        <th>Diff</th>
        <th>K</th>
        <th>U</th>
      </tr>
    </thead>
    <tbody>`;

  employees.forEach(emp => {
    const soll  = calcSoll(emp.vz, workdays, settings.hourFactor);
    const ist   = calcIst(emp.id, currentYear, currentMonth);
    const diff  = Math.round((ist - soll + (emp.vmt||0)) * 10) / 10;
    const diffSign  = diff >= 0 ? '+' : '';
    const diffColor = diff >= 0 ? '#34d399' : '#f87171';
    const pct  = soll > 0 ? Math.min(100, Math.round(ist / soll * 100)) : 0;
    const barColor = pct >= 95 ? '#34d399' : pct >= 70 ? 'var(--accent)' : '#f87171';

    let sick = 0, vac = 0;
    for (let d = 1; d <= total; d++) {
      const ds = dateStr(currentYear, currentMonth, d);
      const c  = shifts[emp.id]?.[ds];
      if (!c) continue;
      if (c.type === 'K') sick++;
      if (c.type === 'U') vac++;
    }

    html += `<tr>
      <td>
        <div style="font-weight:600;font-size:11.5px">${escapeHTML(emp.name)}</div>
        <div style="font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px">${escapeHTML(emp.role)}</div>
      </td>
      <td style="color:var(--accent);font-family:'Space Mono',monospace">${emp.vz}%</td>
      <td style="font-family:'Space Mono',monospace">${soll}h</td>
      <td style="font-family:'Space Mono',monospace">${ist}h</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <div class="stats-bar-wrap">
            <div class="stats-bar" style="width:${pct}%;background:${barColor}"></div>
          </div>
          <span style="font-size:10px;font-family:'Space Mono',monospace;color:var(--text3)">${pct}%</span>
        </div>
      </td>
      <td style="color:${diffColor};font-weight:700;font-family:'Space Mono',monospace">${diffSign}${diff}h</td>
      <td style="color:#f87171;font-weight:600">${sick||'‚Äì'}</td>
      <td style="color:#34d399;font-weight:600">${vac||'‚Äì'}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  cont.innerHTML = html;
}

// =============================================================================
// LOCK
// =============================================================================
function toggleLock() {
  editLocked = !editLocked;
  const btn = document.getElementById('lock-btn');
  btn.textContent = editLocked ? 'üîí' : 'üîì';
  btn.classList.toggle('locked', editLocked);
  showToast(editLocked ? 'üîí Bearbeitung gesperrt' : 'üîì Bearbeitung aktiv');
}

// =============================================================================
// THEME
// =============================================================================
function toggleTheme() {
  darkMode = !darkMode;
  document.body.dataset.theme = darkMode ? 'dark' : 'light';
  document.getElementById('theme-btn').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
  saveLocal();
}

// =============================================================================
// EMPLOYEE MANAGEMENT
// =============================================================================
function openModal(id) {
  if (id === 'modal-employees') renderEmpList();
  if (id === 'modal-shifts')    renderShiftConfig();
  if (id === 'modal-settings')  renderSettings();
  if (id === 'modal-stats')     renderStatsContent();
  document.getElementById(id).classList.add('visible');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('visible');
}

function renderEmpList() {
  const container = document.getElementById('emp-list-container');
  container.innerHTML = '';
  employees.forEach((emp) => {
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    item.setAttribute('draggable', 'true');
    item.dataset.empid = emp.id;
    item.innerHTML = `
      <span class="drag-handle">‚†ø</span>
      <div class="emp-info">
        <div class="name">${emp.name}</div>
        <div class="role">${emp.role} ¬∑ ${emp.vz}% ¬∑ Vmt: ${emp.vmt||0}h</div>
      </div>
      <div class="emp-actions">
        <button class="icon-btn" onclick="openEditEmployee('${emp.id}')" title="Bearbeiten">‚úèÔ∏è</button>
        <button class="icon-btn danger" onclick="deleteEmployee('${emp.id}')" title="Entfernen">üóëÔ∏è</button>
      </div>
    `;
    // Drag for reorder
    item.addEventListener('dragstart', e => { e.dataTransfer.setData('emp-reorder', emp.id); });
    item.addEventListener('dragover', e => { e.preventDefault(); item.style.background = 'var(--accent-light)'; });
    item.addEventListener('dragleave', () => { item.style.background = ''; });
    item.addEventListener('drop', e => {
      e.preventDefault();
      item.style.background = '';
      const fromId = e.dataTransfer.getData('emp-reorder');
      if (fromId === emp.id) return;
      const fromIdx = employees.findIndex(x => x.id === fromId);
      const toIdx   = employees.findIndex(x => x.id === emp.id);
      const [moved] = employees.splice(fromIdx, 1);
      employees.splice(toIdx, 0, moved);
      renderEmpList();
      render();
      saveLocal();
    });
    container.appendChild(item);
  });
}

function openAddEmployee() {
  document.getElementById('emp-edit-title').textContent = 'Mitarbeiter hinzuf√ºgen';
  document.getElementById('emp-name-input').value = '';
  document.getElementById('emp-role-input').value = 'Pflegekraft';
  document.getElementById('emp-vz-input').value = 100;
  document.getElementById('vz-display').textContent = '100%';
  document.getElementById('emp-vmt-input').value = 0;
  document.getElementById('emp-edit-id').value = '';
  openModal('modal-edit-employee');
}

function openEditEmployee(empId) {
  closeModal('modal-employees');
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;
  document.getElementById('emp-edit-title').textContent = 'Mitarbeiter bearbeiten';
  document.getElementById('emp-name-input').value = emp.name;
  document.getElementById('emp-role-input').value = emp.role;
  document.getElementById('emp-vz-input').value = emp.vz;
  document.getElementById('vz-display').textContent = emp.vz + '%';
  document.getElementById('emp-vmt-input').value = emp.vmt || 0;
  document.getElementById('emp-edit-id').value = emp.id;
  openModal('modal-edit-employee');
}

function saveEmployee() {
  const name = document.getElementById('emp-name-input').value.trim().toUpperCase();
  const role = document.getElementById('emp-role-input').value;
  const vz   = parseInt(document.getElementById('emp-vz-input').value);
  const vmt  = parseFloat(document.getElementById('emp-vmt-input').value) || 0;
  const id   = document.getElementById('emp-edit-id').value;

  if (!name) { alert('Bitte Name eingeben.'); return; }

  if (id) {
    const emp = employees.find(e => e.id === id);
    if (emp) { emp.name = name; emp.role = role; emp.vz = vz; emp.vmt = vmt; }
  } else {
    employees.push({ id: 'e' + Date.now(), name, role, vz, vmt });
  }
  closeModal('modal-edit-employee');
  render();
  saveLocal();
  showToast('‚úì Mitarbeiter gespeichert');
}

function deleteEmployee(empId) {
  if (!confirm('Mitarbeiter wirklich entfernen? Alle Dienste dieses Mitarbeiters gehen verloren.')) return;
  employees = employees.filter(e => e.id !== empId);
  delete shifts[empId];
  renderEmpList();
  render();
  saveLocal();
}

// =============================================================================
// SHIFT CONFIG
// =============================================================================
function renderShiftConfig() {
  const container = document.getElementById('shift-config-list');
  container.innerHTML = '';
  let dragSrcIdx = null;

  shiftTypes.forEach((st, idx) => {
    const item = document.createElement('div');
    item.className = 'shift-config-item';
    item.setAttribute('draggable', 'true');
    item.dataset.idx = idx;

    item.innerHTML = `
      <span class="shift-cfg-drag">‚†ø</span>
      <div class="shift-preview" style="background:${st.bg};color:${st.color}">${st.label}</div>
      <div class="shift-config-inputs">
        <input class="label-inp" type="text" value="${escapeHTML(st.label)}" placeholder="K√ºrzel" oninput="updateShiftPreview(this)">
        <input class="name-inp" type="text" value="${escapeHTML(st.name)}" placeholder="Name">
        <input class="hours-inp" type="number" value="${st.hours}" step="0.5" placeholder="h">
        <input class="color-inp" type="color" value="${st.color}" oninput="updateShiftPreview(this)" title="Schriftfarbe">
        <input class="color-inp" type="color" value="${st.bg}" oninput="updateShiftPreview(this)" title="Hintergrundfarbe">
      </div>
      <button class="icon-btn danger" onclick="removeShiftTypeByIdx(${idx})" title="L√∂schen">üóëÔ∏è</button>
    `;

    // Drag reorder
    item.addEventListener('dragstart', e => {
      dragSrcIdx = +item.dataset.idx;
      item.classList.add('dragging-shift-cfg');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => item.classList.remove('dragging-shift-cfg'));
    item.addEventListener('dragover', e => { e.preventDefault(); item.classList.add('drag-over-shift-cfg'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over-shift-cfg'));
    item.addEventListener('drop', e => {
      e.preventDefault();
      item.classList.remove('drag-over-shift-cfg');
      const toIdx = +item.dataset.idx;
      if (dragSrcIdx === null || dragSrcIdx === toIdx) return;
      // Save current input values before reordering
      _syncShiftConfigFromDOM();
      const [moved] = shiftTypes.splice(dragSrcIdx, 1);
      shiftTypes.splice(toIdx, 0, moved);
      renderShiftConfig();
    });

    container.appendChild(item);
  });
}

function _syncShiftConfigFromDOM() {
  const items = document.querySelectorAll('.shift-config-item');
  items.forEach((item, idx) => {
    if (!shiftTypes[idx]) return;
    const inputs = item.querySelectorAll('input');
    shiftTypes[idx].label = inputs[0].value.trim();
    shiftTypes[idx].name  = inputs[1].value.trim();
    shiftTypes[idx].hours = parseFloat(inputs[2].value)||0;
    shiftTypes[idx].color = inputs[3].value;
    shiftTypes[idx].bg    = inputs[4].value;
  });
}

// Make removeShiftType accessible by index at render time
function removeShiftTypeByIdx(idx) {
  shiftTypes.splice(idx, 1);
  renderShiftConfig();
}

function updateShiftPreview(inp) {
  const idx = inp.dataset.idx;
  const field = inp.dataset.field;
  const item = inp.closest('.shift-config-item');
  const preview = item.querySelector('.shift-preview');
  // Update temp
  const label = item.querySelector('[data-field="label"]').value;
  const color = item.querySelector('[data-field="color"]').value;
  const bg    = item.querySelector('[data-field="bg"]').value;
  preview.textContent = label;
  preview.style.color = color;
  preview.style.background = bg;
}

function addShiftType() {
  shiftTypes.push({ id: 'S'+Date.now(), label: 'NEU', name: 'Neuer Dienst', hours: 7.7, color: '#ffffff', bg: '#666666' });
  renderShiftConfig();
}

function removeShiftType(idx) {
  shiftTypes.splice(idx, 1);
  renderShiftConfig();
}

function saveShiftConfig() {
  _syncShiftConfigFromDOM();
  closeModal('modal-shifts');
  renderSidebar();
  renderTable();
  saveLocal();
  showToast('‚úì Dienste gespeichert');
}

// =============================================================================
// SETTINGS
// =============================================================================
function renderSettings() {
  const ct = document.getElementById('col-toggles');
  const colLabels = {vz:'Stellenanteil (VZ)', soll:'Soll-Stunden', ist:'Ist-Stunden', diff:'Differenz (+/‚àí)', vmt:'Vormonat'};
  ct.innerHTML = Object.keys(colLabels).map(key => `
    <div class="toggle-row">
      <span class="toggle-label">${colLabels[key]}</span>
      <label class="toggle-switch">
        <input type="checkbox" data-col="${key}" ${settings.cols[key]?'checked':''}>
        <div class="toggle-slider"></div>
      </label>
    </div>
  `).join('');

  const ft = document.getElementById('footer-toggles');
  ft.innerHTML = shiftTypes.map(st => `
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;padding:4px 8px;border-radius:5px;background:var(--surface2);border:1.5px solid var(--border)">
      <input type="checkbox" data-footer="${st.id}" ${settings.footerShifts[st.id]!==false?'checked':''}>
      <span style="display:inline-block;width:28px;height:22px;border-radius:4px;background:${st.bg};color:${st.color};font-size:9px;font-weight:700;text-align:center;line-height:22px">${st.label}</span>
    </label>
  `).join('');

  document.getElementById('hour-factor-input').value = settings.hourFactor;
}

function applySettings() {
  document.querySelectorAll('#col-toggles input[data-col]').forEach(inp => {
    settings.cols[inp.dataset.col] = inp.checked;
  });
  document.querySelectorAll('#footer-toggles input[data-footer]').forEach(inp => {
    settings.footerShifts[inp.dataset.footer] = inp.checked;
  });
  settings.hourFactor = parseFloat(document.getElementById('hour-factor-input').value) || 7.7;
  closeModal('modal-settings');
  render();
  saveLocal();
  showToast('‚úì Einstellungen gespeichert');
}

// =============================================================================
// DRAG & DROP ROWS (in table)
// =============================================================================
let dragEmpId = null;
function dragStart(e, empId) {
  if (editLocked) { e.preventDefault(); return; }
  dragEmpId = empId;
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    e.target.closest('tr').classList.add('dragging');
  }, 0);
}
function dragOver(e) {
  if (!dragEmpId) return;
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}
function dropRow(e, targetEmpId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragEmpId || dragEmpId === targetEmpId) return;
  const fromIdx = employees.findIndex(x => x.id === dragEmpId);
  const toIdx   = employees.findIndex(x => x.id === targetEmpId);
  const [moved] = employees.splice(fromIdx, 1);
  employees.splice(toIdx, 0, moved);
  dragEmpId = null;
  render();
  saveLocal();
}
function dragEnd(e) {
  document.querySelectorAll('.emp-row').forEach(r => {
    r.classList.remove('drag-over', 'dragging');
  });
  dragEmpId = null;
}

// =============================================================================
// PDF / PRINT
// =============================================================================
function printPDF() {
  showToast('‚è≥ PDF wird vorbereitet‚Ä¶');
  setTimeout(() => { window.print(); }, 300);
}

// =============================================================================
// TOAST
// =============================================================================
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.classList.remove('show'); }, 2500);
}

// =============================================================================
// ESCAPE HTML
// =============================================================================
function escapeHTML(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// =============================================================================
// PERSISTENCE ‚Äì LOCAL STORAGE
// =============================================================================
const LS_KEY = 'dienstplan-pro-data';

function getState() {
  return { employees, shifts, shiftTypes, settings, darkMode, currentYear, currentMonth, currentZoom };
}

function saveLocal() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(getState()));
  } catch(e) {}
}

function loadLocal() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const d = JSON.parse(raw);
    if (d.employees) employees = d.employees;
    if (d.shifts)    shifts    = d.shifts;
    if (d.shiftTypes) shiftTypes = d.shiftTypes;
    if (d.settings)  settings  = { ...settings, ...d.settings };
    if (d.darkMode !== undefined) {
      darkMode = d.darkMode;
      document.body.dataset.theme = darkMode ? 'dark' : 'light';
      document.getElementById('theme-btn').textContent = darkMode ? '‚òÄÔ∏è' : 'üåô';
    }
    if (d.currentZoom) { currentZoom = d.currentZoom; setZoom(currentZoom); }
    return true;
  } catch(e) { return false; }
}

// =============================================================================
// PERSISTENCE ‚Äì FIREBASE
// =============================================================================
async function saveFirebase() {
  const db = window.__firebaseDB;
  if (!db || !window.__firebaseReady) return false;
  try {
    const { doc, setDoc } = window.__firestoreAPI;
    const key = `plan-${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
    await setDoc(doc(db, 'dienstplan', key), getState());
    return true;
  } catch(e) {
    console.error('Firebase save error', e);
    return false;
  }
}

async function loadFirebase() {
  const db = window.__firebaseDB;
  if (!db || !window.__firebaseReady) return false;
  try {
    const { doc, getDoc } = window.__firestoreAPI;
    const key = `plan-${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
    const snap = await getDoc(doc(db, 'dienstplan', key));
    if (snap.exists()) {
      const d = snap.data();
      if (d.employees) employees = d.employees;
      if (d.shifts)    shifts    = d.shifts;
      if (d.shiftTypes) shiftTypes = d.shiftTypes;
      if (d.settings)  settings  = { ...settings, ...d.settings };
      return true;
    }
  } catch(e) { console.error('Firebase load error', e); }
  return false;
}

function updateSyncBadge(online) {
  const badge = document.getElementById('sync-badge');
  const text  = document.getElementById('sync-text');
  if (online) {
    badge.className = 'sync-badge online';
    text.textContent = 'Cloud-Sync';
  } else {
    badge.className = 'sync-badge offline';
    text.textContent = 'Lokal';
  }
}

async function saveAll() {
  saveLocal();
  const saved = await saveFirebase();
  updateSyncBadge(saved);
  showToast(saved ? '‚òÅÔ∏è In Cloud gespeichert!' : 'üíæ Lokal gespeichert');
}

// =============================================================================
// INIT
// =============================================================================
async function init() {
  // Load local first (fast)
  loadLocal();

  // Try Firebase
  window.addEventListener('firebaseReady', async () => {
    const fb = await loadFirebase();
    updateSyncBadge(fb);
    if (fb) render();
  });

  // Initialize settings.footerShifts for all shift types
  shiftTypes.forEach(st => {
    if (settings.footerShifts[st.id] === undefined) settings.footerShifts[st.id] = true;
  });

  render();
  setZoom(currentZoom);

  // Hide loader
  setTimeout(() => {
    document.getElementById('loading').classList.add('hidden');
  }, 600);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('visible');
  });
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.visible').forEach(m => m.classList.remove('visible'));
    document.getElementById('note-popup').classList.remove('visible');
    document.getElementById('context-menu').classList.remove('visible');
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveAll();
  }
});

init();
</script>
</body>
</html>
